#!/usr/bin/env php
<?php

/**
 * Generates a minimal apache config to serve a php file, or a directory
 * @author Lachlan Donald <lachlan@ljd.cc>
 */

if(!isset($argv[1]) || in_array('--help', $argv))
{
	echo "usage: phpup [-p port] [file or dir...] \n\n";
	echo " -p port  -  use an alternate port, defaults to 8000\n";
	exit(1);
}

$user = posix_getpwuid(posix_geteuid());
$options = getopt("p:");
$tmpdir = rtrim(getenv('TMPDIR'),'/');
$port = isset($options['p']) ? $options['p'] : 8000;

// serve either a file or a directory
if(is_file($argv[1]))
{
	$file = realpath($argv[1]); 
	$dir = dirname($file);
}
else if(is_dir($argv[1]))
{
	$file = false;
	$dir = realpath($argv[1]);
}
else
{
	die("{$argv[1]} not readable");
}

// ----------------------------
// env setups 

$apachedir = $tmpdir."/.phpup{$port}";

printf(">> building local apache instance with %s\n", $file ? $file : $dir);

if(is_dir($apachedir))
	`rm -rf $apachedir`;

mkdir($apachedir, 0700, true);

$config = <<<"APACHECONF"
ServerRoot $apachedir 
PidFile httpd.pid 
ScoreBoardFile httpd.scoreboard
LockFile accept.lock
HostnameLookups off
User {$user['name']} 
ServerSignature Off
UseCanonicalName Off
Timeout 50
KeepAlive On
MaxKeepAliveRequests 40
KeepAliveTimeout 5
ServerName phpup
StartServers 16
MinSpareServers 16
MaxSpareServers 32
ServerLimit 400
MaxClients 400
MaxRequestsPerChild 10000
Listen *:$port
DocumentRoot $dir 
LoadModule mime_module /usr/libexec/apache2/mod_mime.so
LoadModule php5_module /usr/libexec/apache2/libphp5.so 
LoadModule log_config_module /usr/libexec/apache2/mod_log_config.so
AddHandler php5-script .php 
LogFormat "%h %l %u %t \"%r\" %>s %b" common
CustomLog "access.log" common
ErrorLog "error.log"\n
APACHECONF;

if($file)
{
	$config .= <<<"REWRITECONF"
LoadModule rewrite_module /usr/libexec/apache2/mod_rewrite.so
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule .* /{$file} [L,QSA]\n
REWRITECONF;
}
else
{
	$config .= <<<"DIRCONFIG"
<Directory $dir>
Options All Indexes FollowSymLinks MultiViews
AllowOverride all
</Directory>\n
DIRCONFIG;
}

file_put_contents("$apachedir/apache.conf", $config);

printf(">> starting apache on port %d\n", $port);
$handle = popen("httpd -f apache.conf -d $apachedir -D FOREGROUND", "r");
printf(">> listening...\n");

sleep(2);
$accesslog = popen("tail -f $apachedir/access.log 2>&1", 'r');
while(!feof($accesslog)) 
	printf(fgets($accesslog));



